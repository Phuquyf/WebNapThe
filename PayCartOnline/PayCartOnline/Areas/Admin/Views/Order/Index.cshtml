
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    int total = ViewBag.total;
    int countOrder = ViewBag.count;
    var orderSuccess = ViewBag.orderSuccess;
    var order_Error = ViewBag.order_Error;
    System.Globalization.CultureInfo culture = new System.Globalization.CultureInfo("en-US");
    List<PayCartOnline.Models.Denomination> denominations = ViewBag.denomination;
    var startDate = ViewBag.startDate != null ? ViewBag.startDate : null;
    var expiration = ViewBag.expiration != null ? ViewBag.expiration : null;
    var status = ViewBag.status != null ? ViewBag.status : null;
    var phone=ViewBag.phone != null ? ViewBag.phone : null;
    var id_denomination= ViewBag.id_denomination != null ? ViewBag.id_denomination : null;

}
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Quản Lý Đơn Hàng</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active"><a href="/Admin/Order">Quản Lý Đơn Hàng</a></li>
                    </ol>
                </div>

            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 col-12">
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="far fa-envelope"></i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Tổng tiền tất cả đơn hàng</span>



                                    <span class="info-box-number">@String.Format(culture, "{0:N0}", @total) VND</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <!-- /.col -->
                        <div class="col-md-3 col-sm-6 col-12">
                            <div class="info-box">
                                <span class="info-box-icon bg-success"><i class="far fa-flag"></i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Tổng Số Giao Dịch</span>


                                    <span class="info-box-number">@countOrder</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <!-- /.col -->
                        <div class="col-md-3 col-sm-6 col-12">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning"><i class="far fa-copy"></i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Số Đơn Thành Công</span>



                                    <span class="info-box-number">@orderSuccess</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <!-- /.col -->
                        <div class="col-md-3 col-sm-6 col-12">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger"><i class="far fa-star"></i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Số Đơn Lỗi</span>



                                    <span class="info-box-number">@order_Error</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <!-- /.col -->
                    </div>
                    
                    <div class="card">
                        
                            <div class="card-header row">

                                <!-- Date range -->
                                <div class="form-group col-lg-4 col-sm-4 col-md-4">
                                    <label>Ngày bắt đầu</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">

                                        </div>
                                        @if (startDate != null)
                                        {
                                            <input type="date" name="startDate" class="form-control float-right" id="startDate" value="@startDate">
                                        }
                                        else
                                        {
                                            <input type="date" name="startDate" class="form-control float-right" id="startDate">
                                        }

                                    </div>
                                    <!-- /.input group -->
                                </div>
                                <div class="form-group col-lg-4 col-sm-4 col-md-4">
                                    <label>Ngày kết thúc :</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">

                                        </div>
                                        <input type="date" name="expiration" class="form-control float-right" id="expiration">
                                    </div>
                                    <!-- /.input group -->
                                </div>
                                <!-- /.form group -->
                                <!-- Date and time range -->
                                <div class="form-group col-md-4 col-lg-4 col-sm-4 ">
                                    <label>Status</label>
                                    <select class="form-control select2" style="width: 100%;" id="status" name="status">
                                        <option selected="selected">Tất cả</option>
                                        @if (status != null)
                                        {
                                            if (status == 1)
                                            {
                                                <option value="1" selected>Thành Công</option>
                                                <option value="2">Hủy</option>
                                                <option value="-1">Chưa Thanh Toán</option>
                                            }
                                            else if (status == -1)
                                            {
                                                <option value="1">Thành Công</option>
                                                <option value="2">Hủy</option>
                                                <option value="-1" selected>Chưa Thanh Toán</option>
                                            }
                                            else
                                            {
                                                <option value="1">Thành Công</option>
                                                <option value="2" selected>Hủy</option>
                                                <option value="-1">Chưa Thanh Toán</option>
                                            }

                                        }
                                        else
                                        {
                                            <option value="1">Thành Công</option>
                                            <option value="2">Hủy</option>
                                            <option value="-1">Chưa Thanh Toán</option>
                                        }



                                    </select>
                                </div>
                                <div class="form-group col-lg-4 col-sm-4 col-md-4">
                                    @*<label>Search SĐT :</label>*@
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                        </div>

                                        @if (phone != null)
                                        {
                                            <input type="number" name="phone" class="form-control float-right" id="phone" placeholder=" Số Điện Thoại" value="@phone">
                                        }
                                        else
                                        {
                                            <input type="number" name="phone" class="form-control float-right" id="phone" placeholder=" Số Điện Thoại" >
                                        }

                                    </div>
                                    <!-- /.input group -->
                                </div>
                                <div class="form-group col-lg-4 col-sm-4 col-md-4">
                                    @*<label>Search Mệnh Giá :</label>*@
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                        </div>
                                        <select class="form-control select2" style="width: 100%;" name="id_denomination" id="id_denomination">
                                            <option selected="selected">Mệnh giá</option>
                                            @foreach (var item in denominations)
                                            {
                                                if (id_denomination == item.ID)
                                                {
                                                    <option selected value="@item.ID">@String.Format(culture, "{0:N0}", @item.Price)VND</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.ID">@String.Format(culture, "{0:N0}", @item.Price)VND</option>
                                                }

                                            }


                                        </select>
                                    </div>
                                    <!-- /.input group -->
                                </div>
                                <div class="form-group col-lg-4 col-sm-4 col-md-4">
                                    @*<label>abc</label>*@
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                        </div>
                                        <button onclick="submit()" class="btn btn-success">Tìm Kiếm</button>
                                        <button id="btnGroupDrop1" class="btn btn-light dropdown-toggle ml-3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Hành động
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                                            <button class="dropdown-item"onclick=""><i class="far fa-file-excel" style="margin-right:5px"></i>Nhập Excel</button>
                                            <button class="dropdown-item" onclick="ExportExcel()"><i class="far fa-file-excel" style="margin-right:5px"></i>Xuất Excel</button>
                                        </div>
                                    </div>
                                   
                                </div>
                       
                    </div>
                  
                    <!-- /.card-header -->
                    <div class="card-body">
                        

                        <div class="row">
                            <table id="example" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Mã Đơn hàng</th>
                                        <th>Số Điện Thoại</th>
                                        <th>Nhà Mạng</th>
                                        <th>Mệnh Giá</th>
                                        <th>Loại Thẻ</th>
                                        <th>Phương Thức Thanh Toán</th>
                                        <th>Ngân Hàng</th>
                                        <th>Trạng Thái</th>
                                        <th>Ngày Thanh Toán</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="content">
                                    @foreach (var item in ViewBag.orders)
                                    {
                                    <tr>
                                        <td>@item.Code_Order</td>
                                        <td>@item.Phone </td>
                                        <td>@item.Brand</td>
                                        <td>@String.Format(culture, "{0:N0}", @item.Total)VND</td>
                                        <td>@item.CardType</td>
                                        <td>VNPAY</td>
                                        <td>@item.BankCode</td>
                                        @if (item.Status.Equals("Thành Công"))
                                        {
                                            <td><span style="color:green;font-size:12px;"><b>@item.Status</b></span></td>
                                        }
                                        else if (item.Status.Equals("Chưa Thanh Toán"))
                                        {
                                            <td><span style="color:orange;font-size:12px;"><b>@item.Status</b></span></td>
                                        }
                                        else
                                        {
                                            <td><span style="color:red;font-size:12px;"><b>@item.Status</b></span></td>
                                        }

                                        <td>@item.Create_At</td>

                                        <td><a href="/Admin/Order/OrderDetail?id=@item.Id_order"><i class="fa fa-eye" aria-hidden="true"></i></a></td>

                                    </tr>
                                    }


                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>Mã Đơn hàng</th>
                                        <th>Số Điện Thoại</th>
                                        <th>Nhà Mạng</th>
                                        <th>Mệnh Giá</th>
                                        <th>Thể Loại Thẻ</th>
                                        <th>Phương Thức Thanh Toán</th>
                                        <th>Tên Ngân Hàng</th>
                                        <th>Trạng Thái</th>
                                        <th>Ngày Thanh Toán</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>

                        </div>
                        <div class="row">
                            <div class="col-6">
                                <p class="float-sm-left edit_size">Showing 1 to @ViewBag.numSize of  @ViewBag.totalPage entries</p>
                            </div>

                            <div class="col-6">
                                <ul class="pagination  float-sm-right">

                                    @{
                                        int position;
                                        int pageCurrent = ViewBag.pageCurrent;

                                        float numSize = ViewBag.numSize;

                                        if (pageCurrent > 1)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" href="@Url.Action("/Index", new {page = pageCurrent-1 })" tabindex="-1">Previous</a>
                                            </li>
                                        }

                                        for (position = 1; position <= numSize; position++)
                                        {

                                            if (position == pageCurrent)
                                            {
                                                <li class="page-item active">
                                                    <a class="page-link" href="@Url.Action("/Index", new {page = position })">@position</a>
                                                </li>
                                            }

                                            else
                                            {
                                                <li class="page-item">
                                                    <a class="page-link" href="@Url.Action("/Index", new {page = position })">@position</a>
                                                </li>
                                            }

                                        }
                                        if (pageCurrent > 0 && pageCurrent < numSize)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" href="@Url.Action("/Index", new {page = pageCurrent+1 })" tabindex="-1">Next</a>
                                            </li>
                                        }

                                    }

                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>
<script>
    var orders = @Html.Raw(Json.Encode(ViewBag.orders));
    
    const submit = () => {
        let id_denomination = $('#id_denomination').val();
        let phone = $('#phone').val();
        let status = $('#status').val();
        let expiration = $('#expiration').val();
        let startDate = $('#startDate').val();



        if (startDate === '' && expiration === '' && phone === '' && status === 'Tất cả' && id_denomination === 'Mệnh giá') {

            alert('Bạn chưa chọn trường tìm kiếm')
            return;
        }

        if (phone != '' && phone.toString().length != 9) {
            alert('nhập lại số phone đúng định dạng')
            return;
        }

        if (startDate != '' && expiration == '' || startDate == '' && expiration != '') {

            alert('Chưa chọn đủ trường')
            return
        }

        console.log(startDate + '' + expiration)
        if (startDate != '' && expiration != '') {
            if (!(Date.parse(startDate) < Date.parse(expiration))) {
                alert('chọn lại ngày tìm kiếm')
                return;
            }
        }

        window.location="/Admin/Order?startDate=" + startDate + "&&expiration=" + expiration +
            "&status=" + status + "&phone=" + phone + "&id_denomination=" + id_denomination


    }

    const ExportExcel = () => {
       

        let id_denomination = $('#id_denomination').val();
        let phone = $('#phone').val();
        let status = $('#status').val();
        let expiration = $('#expiration').val();
        let startDate = $('#startDate').val();

        window.location = "/Admin/Order/ExportExcel?startDate=" + startDate + "&&expiration=" + expiration +
            "&status=" + status + "&phone=" + phone + "&id_denomination=" + id_denomination

       
    }
</script>
